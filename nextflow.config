profiles {
    slurm {
        process.executor = 'slurm'
        singularity.enabled = true
        conda.enabled = true   // allow conda usage in this profile
        conda.cacheDir = "${baseDir}/.conda_cache"    
    }
}

params {
    outdir   = 'results'
    test_run = false
    upstream_seq    = 'CACGAGGTGTACGAT'
    downstream_seq  = 'CAGAATTGGGAGTCT'
}

process {
    // defaults (optional): only used when not overridden by withName
    errorStrategy = 'terminate'
    maxRetries    = 1

    withName: extract_barcodes_process {
        conda     = params.conda ? 'envs/2fast2q.yaml' : null
        container = params.singularity ? 'docker://ghcr.io/karchern/2fast2q@sha256:f5f8f9505aac8496abc1cddb5575e661be90f0119c8ff7a5ad814f2165d4c58c' : null
        cpus      = 1

        // test run: tiny, fixed resources, no retries
        // real run: adaptive, increasing with attempts
        memory = params.test_run
            ? '1 GB'
            : { 32.GB * task.attempt }      // 16 GB, 32 GB, 48 GB, ...

        time = params.test_run
            ? '2m'
            : { 30.m * task.attempt }       // 15m, 30m, 45m, ...

        errorStrategy = params.test_run
            ? 'terminate'
            : { (task.exitStatus in 137..140) ? 'retry' : 'terminate' }

        maxRetries = params.test_run ? 1 : 3
    }

    withName: merge_barcode_matrices_process {
        container = params.singularity ? 'docker://rocker/tidyverse:latest' : null
        cpus      = 1

        memory = params.test_run
            ? '512 MB'
            : { 8.GB * task.attempt }

        time = params.test_run
            ? '1m'
            : { 15.m * task.attempt }

        errorStrategy = params.test_run
            ? 'terminate'
            : { (task.exitStatus in 137..140) ? 'retry' : 'terminate' }

        maxRetries = params.test_run ? 1 : 3
    }

    withName: run_mbarq_process {
        container = params.singularity ? 'docker://ghcr.io/karchern/mbarq@sha256:124869626aa084a7cb4a281247e2548bcf1290c8cadbde522de42b8f09edf281' : null
        cpus      = 1

        memory = params.test_run
            ? '512 MB'
            : { 64.GB * task.attempt }

        time = params.test_run
            ? '2m'
            : { 60.m * task.attempt }

        errorStrategy = params.test_run
            ? 'terminate'
            : { (task.exitStatus in 137..140) ? 'retry' : 'terminate' }

        maxRetries = params.test_run ? 1 : 3
    }
}
